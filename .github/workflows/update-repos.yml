name: Update Repository List

on:
  schedule:
    - cron: '0 6 * * *'  # Run daily at 6 AM UTC
  workflow_dispatch:      # Allow manual trigger
  push:
    branches: [ main ]

jobs:
  update-repos:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Fetch Organization Repositories
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_NAME: ${{ github.repository_owner }}
        run: |
          # Fetch all repositories from the organization
          curl -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/orgs/$ORG_NAME/repos?per_page=100&sort=updated" > all_repos.json
          
          # Process repositories and check for GitHub Pages
          node -e "
          const fs = require('fs');
          const repos = JSON.parse(fs.readFileSync('all_repos.json', 'utf8'));
          
          const processedRepos = repos.map(repo => ({
            name: repo.name,
            description: repo.description || 'No description available',
            html_url: repo.html_url,
            homepage: repo.homepage,
            has_pages: repo.has_pages,
            pages_url: repo.has_pages ? \`https://${{ github.repository_owner }}.github.io/\${repo.name}\` : null,
            updated_at: repo.updated_at,
            language: repo.language,
            stars: repo.stargazers_count,
            forks: repo.forks_count
          }));
          
          fs.writeFileSync('repos.json', JSON.stringify(processedRepos, null, 2));
          "
          
      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add repos.json
          git diff --staged --quiet || git commit -m "Update repository list"
          git push
